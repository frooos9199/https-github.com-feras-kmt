// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id @default(cuid())
  employeeId         String   @unique // KMT-100, KMT-101, etc.
  name               String
  email              String   @unique
  password           String
  phone              String
  civilId            String?
  dateOfBirth        DateTime?
  nationality        String? // Nationality field
  bloodType          String? // Blood type (A+, A-, B+, B-, O+, O-, AB+, AB-)
  image              String?
  civilIdImage       String? // Civil ID front image
  civilIdBackImage   String? // Civil ID back image
  licenseFrontImage  String? // Driver license front image
  licenseBackImage   String? // Driver license back image
  isActive           Boolean  @default(true) // Active/Suspended status
  marshalTypes       String   @default("") // Comma-separated: "drag-race,drift,circuit"
  role               String   @default("marshal") // "marshal" or "admin"
  fcmToken           String?  // Firebase Cloud Messaging token for push notifications
  resetToken         String?  // Password reset token
  resetTokenExpiry   DateTime? // Password reset token expiry
  lastLogin          DateTime? // آخر وقت تسجيل دخول
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  attendances   Attendance[]
  eventMarshals EventMarshal[] @relation("EventMarshalToUser")
  notifications Notification[]
}

model Event {
  id            String   @id @default(cuid())
  titleEn       String
  titleAr       String
  descriptionEn String
  descriptionAr String
  date          DateTime // Start date
  endDate       DateTime? // End date for multi-day events
  time          String
  endTime       String? // End time for the event
  location      String
  image         String?
  marshalTypes  String   @default("") // Comma-separated: "drag-race,drift,circuit"
  maxMarshals   Int
  status        String   @default("active") // "active", "cancelled", "completed"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  attendances   Attendance[]
  eventMarshals EventMarshal[]
}

model EventMarshal {
  id          String   @id @default(cuid())
  eventId     String
  marshalId   String   // User ID of the marshal
  status      String   @default("invited") // "invited", "accepted", "declined", "approved", "rejected"
  invitedAt   DateTime @default(now())
  respondedAt DateTime? // When marshal responded to invitation
  notes       String?

  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  marshal User  @relation("EventMarshalToUser", fields: [marshalId], references: [id], onDelete: Cascade)

  @@unique([eventId, marshalId])
}

model Attendance {
  id              String    @id @default(cuid())
  userId          String
  eventId         String
  status          String    @default("pending") // "pending", "approved", "rejected", "cancelled"
  registeredAt    DateTime  @default(now())
  notes           String?
  cancelledAt     DateTime? // When marshal cancelled their registration
  cancellationReason String? // Why marshal cancelled

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "NEW_EVENT", "REGISTRATION_APPROVED", "REGISTRATION_REJECTED", "EVENT_REMINDER", "EVENT_UPDATED", "EVENT_CANCELLED"
  titleEn   String
  titleAr   String
  messageEn String
  messageAr String
  eventId   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model BroadcastMessage {
  id               String   @id @default(cuid())
  subject          String
  message          String
  recipientFilter  String   // "all", "approved", "pending", "by-type", "by-event"
  marshalTypes     String?  // For filtering by type: "drag-race,drift,circuit"
  eventId          String?  // For filtering by event
  sendEmail        Boolean  @default(true)
  sendNotification Boolean  @default(true)
  priority         String   @default("normal") // "normal", "high", "urgent"
  sentBy           String   // Admin user ID
  sentAt           DateTime @default(now())
  recipientCount   Int      @default(0)
  
  @@index([sentAt])
}

// جدول تتبع العمليات - لمراقبة جميع العمليات في النظام
model OperationLog {
  id            String   @id @default(cuid())
  operation     String   // "event_create", "user_register", "attendance_request", "email_send", "notification_send", "admin_approve"
  userId        String?  // المستخدم اللي عمل العملية
  targetId      String?  // ID الهدف (event, user, attendance, etc.)
  status        String   // "success", "error", "pending"
  duration      Int?     // مدة العملية بالميلي ثانية
  errorMessage  String?  // رسالة الخطأ لو فشلت
  metadata      Json?    // بيانات إضافية (IP, UserAgent, etc.)
  createdAt     DateTime @default(now())

  @@index([operation, status])
  @@index([createdAt])
  @@index([userId])
}

// جدول الأخطاء - لتتبع وتحليل الأخطاء
model ErrorLog {
  id          String   @id @default(cuid())
  type        String   // "api_error", "db_error", "email_error", "notification_error", "auth_error"
  operation   String?  // العملية اللي سبب الخطأ
  message     String   // رسالة الخطأ
  stack       String?  // Stack trace
  userId      String?  // المستخدم المتأثر
  url         String?  // الصفحة أو API endpoint
  userAgent   String?  // معلومات المتصفح/التطبيق
  ip          String?  // عنوان IP
  severity    String   @default("medium") // "low", "medium", "high", "critical"
  resolved    Boolean  @default(false)   // هل تم حل المشكلة
  resolvedAt  DateTime? // وقت الحل
  createdAt   DateTime @default(now())

  @@index([type, severity])
  @@index([createdAt])
  @@index([resolved])
}

// جدول إحصائيات النظام - للتقارير اليومية
model SystemStats {
  id                    String   @id @default(cuid())
  date                  DateTime @db.Date // التاريخ
  totalUsers            Int      @default(0)
  activeUsers           Int      @default(0)
  totalEvents           Int      @default(0)
  totalAttendances      Int      @default(0)
  pendingRequests       Int      @default(0)
  totalOperations       Int      @default(0)
  successfulOperations  Int      @default(0)
  failedOperations      Int      @default(0)
  averageResponseTime   Float    @default(0) // بالميلي ثانية
  emailsSent            Int      @default(0)
  notificationsSent     Int      @default(0)
  serverUptime          Float    @default(0) // نسبة الـ uptime
  createdAt             DateTime @default(now())

  @@unique([date])
  @@index([date])
}
